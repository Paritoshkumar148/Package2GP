version: 2.1

executors:
  salesforce-executor:
    docker:
      - image: circleci/node:16
    working_directory: ~/project

jobs:
  authorize_dev_hub:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: "Install Salesforce CLI"
          command: |
            npm install --global sfdx-cli
            sfdx --version
      - run:
          name: "Authenticate Dev Hub"
          command: |
            echo $DEVHUB_SFDX_URL > sfdx_auth.txt
            sfdx auth:sfdxurl:store --sfdx-url-file sfdx_auth.txt --set-default-dev-hub

  create_scratch_org:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: "Create Scratch Org"
          command: |
            sfdx force:org:create -f config/project-scratch-def.json -a CircleCI_Scratch -d 1 -s

  deploy_and_test:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: "Deploy Metadata"
          command: |
            sfdx force:source:push -u CircleCI_Scratch
      - run:
          name: "Run Apex Tests"
          command: |
            sfdx force:apex:test:run -u CircleCI_Scratch -r human

workflows:
  version: 2
  deploy_and_test:
    jobs:
      - authorize_dev_hub
      - create_scratch_org:
          requires:
            - authorize_dev_hub
      - deploy_and_test:
          requires:
            - create_scratch_org
