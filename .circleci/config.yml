version: 2.1

executors:
  salesforce-executor:
    docker:
      - image: cimg/node:18.17  # âœ… Uses Node.js 18 with NPM pre-installed
    working_directory: ~/project

jobs:
  install_salesforce_cli:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Install Salesforce CLI
          command: |
            mkdir -p ~/.npm-global
            npm config set prefix '~/.npm-global'
            export PATH=~/.npm-global/bin:$PATH
            echo 'export PATH=~/.npm-global/bin:$PATH' >> $BASH_ENV
            npm install --global @salesforce/cli
            exec bash  # Restart shell to apply changes
      - run:
          name: Verify Salesforce CLI Installation
          command: |
            echo "Current PATH: $PATH"
            which sf || echo "Salesforce CLI not found!"
            sf --version || echo "Salesforce CLI version check failed!"

  authenticate:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Debug PATH and Environment
          command: |
            echo "Current PATH: $PATH"
            ls -la ~/.npm-global/bin
            echo "BASH_ENV Content:"
            cat $BASH_ENV
      - run:
          name: Ensure Salesforce CLI is Available
          command: |
            export PATH=~/.npm-global/bin:$PATH
            source $BASH_ENV
            which sf || echo "Salesforce CLI not found!"
            sf --version || echo "Salesforce CLI version check failed!"
      - run:
          name: Authenticate with Salesforce
          command: |
            echo $SFDC_JWT_KEY | base64 --decode > server.key
            sf org login jwt --client-id $SFDC_CONSUMER_KEY --jwt-key-file server.key --username $SFDC_USERNAME --instance-url https://login.salesforce.com
            sf org list

  create-scratch-org:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Ensure Salesforce CLI is Available
          command: |
            export PATH=~/.npm-global/bin:$PATH
            source $BASH_ENV
            sf --version
      - run:
          name: Create Scratch Org
          command: sf org create scratch -f config/project-scratch-def.json -a CircleCIScratchOrg -d 1 -s
      - run:
          name: Push Source Code
          command: sf project deploy start
      - run:
          name: Run Apex Tests
          command: sf apex run test --result-format human --code-coverage --wait 10
      - run:
          name: Delete Scratch Org
          command: sf org delete scratch -u CircleCIScratchOrg -p

  deploy-to-prod:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Ensure Salesforce CLI is Available
          command: |
            export PATH=~/.npm-global/bin:$PATH
            source $BASH_ENV
            sf --version
      - run:
          name: Deploy to Production
          command: sf project deploy start -x manifest/package.xml -o $SFDC_USERNAME --wait 10

workflows:
  version: 2
  deploy:
    jobs:
      - install_salesforce_cli
      - authenticate:
          requires:
            - install_salesforce_cli
      - create-scratch-org:
          requires:
            - authenticate
      - deploy-to-prod:
          requires:
            - create-scratch-org
