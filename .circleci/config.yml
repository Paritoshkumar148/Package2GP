version: 2.1

executors:
  salesforce-executor:
    docker:
      - image: circleci/node:18
    working_directory: ~/project

jobs:
  setup:
    executor: salesforce-executor
    steps:
      - checkout
      
      # Install Salesforce CLI (Recommended official method)
      - run:
          name: Install Salesforce CLI
          command: |
            curl -fsSL https://developer.salesforce.com/media/salesforce-cli/install.sh | bash
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      # Verify installation
      - run: sfdx --version
      
      # Authenticate with Salesforce using JWT
      - run:
          name: Authenticate with Salesforce
          command: |
            echo $SFDC_SERVER_KEY | base64 --decode > server.key
            sfdx auth:jwt:grant --client-id $SFDC_CONSUMER_KEY \
                                --username $SFDC_USERNAME \
                                --jwt-key-file server.key \
                                --instance-url https://login.salesforce.com

  deploy:
    executor: salesforce-executor
    steps:
      - checkout

      # Authenticate again for deployment
      - run:
          name: Authenticate with Salesforce
          command: |
            echo $SFDC_SERVER_KEY | base64 --decode > server.key
            sfdx auth:jwt:grant --client-id $SFDC_CONSUMER_KEY \
                                --username $SFDC_USERNAME \
                                --jwt-key-file server.key \
                                --instance-url https://login.salesforce.com

      # Deploy metadata
      - run:
          name: Deploy Salesforce Metadata
          command: |
            sfdx force:source:deploy -p force-app --wait 10

workflows:
  version: 2
  deploy:
    jobs:
      - setup
      - deploy:
          requires:
            - setup
