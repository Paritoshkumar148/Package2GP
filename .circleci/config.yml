version: 2.1

executors:
  default:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/project

jobs:
  deploy:
    executor: default
    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: npm install

      - run:
          name: Install Salesforce CLI (Fix Permissions)
          command: |
            echo "ğŸš€ Installing Salesforce CLI..."
            mkdir -p ~/.npm-global
            npm config set prefix '~/.npm-global'
            export PATH=~/.npm-global/bin:$PATH
            echo 'export PATH=~/.npm-global/bin:$PATH' >> $BASH_ENV
            npm install -g @salesforce/cli || (echo "âŒ Salesforce CLI installation failed!" && exit 1)
            sf --version
            echo "âœ… Salesforce CLI installed successfully!"

      - run:
          name: Authenticate Dev Hub
          command: |
            echo "ğŸ” Authenticating Dev Hub..."
            rm -f sfdx_auth_url.txt
            echo "$SF_AUTH_URL" > sfdx_auth_url.txt
            sf org login sfdx-url -f sfdx_auth_url.txt --set-default-dev-hub || (echo "âŒ Dev Hub authentication failed!" && exit 1)
            echo "âœ… Dev Hub authentication successful123!"

      - run:
          name: Create Scratch Org
          command: |
            echo "ğŸ“Œ Creating Scratch Org..."
            sf org create scratch --definition-file config/project-scratch-def.json --set-default --alias scratchOrg --duration-days 7 || (echo "âŒ Scratch org creation failed!" && exit 1)
            echo "âœ… Scratch org created!"

      - run:
          name: Deploy Metadata
          command: |
            echo "ğŸš€ Deploying metadata to Scratch Org..."
            sf project deploy --target-org scratchOrg || (echo "âŒ Metadata deployment failed!" && exit 1)
            echo "âœ… Metadata deployed!"

      - run:
          name: Run Apex Tests
          command: |
            echo "ğŸ§ª Running Apex tests..."
            sf apex run test --target-org scratchOrg --result-format human --code-coverage --wait 10 || (echo "âŒ Apex tests failed!" && exit 1)
            echo "âœ… Apex tests completed!"

      - run:
          name: Deploy to Production
          command: |
            echo "ğŸš€ Deploying to Production..."
            sf project deploy --target-org myOrg --manifest package.xml --test-level RunLocalTests || (echo "âŒ Deployment to Production failed!" && exit 1)
            echo "âœ… Deployment to Production completed!"

workflows:
  version: 2
  deploy:
    jobs:
      - deploy
