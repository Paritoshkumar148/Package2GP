version: 2.1

executors:
  default:
    docker:
      - image: cimg/node:18.17-browsers # Updated Node.js image
    working_directory: ~/project

jobs:
  deploy:
    executor: default
    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: npm install

      - run:
          name: Install Salesforce CLI
          command: |
            echo "üöÄ Installing Salesforce CLI..."
            npm install -g @salesforce/cli --unsafe-perm=true
            echo 'export PATH=$HOME/.npm-global/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            sf --version || echo "Salesforce CLI installation failed!"

      - run:
          name: Authenticate Salesforce Org
          command: |
            echo "Authenticating Salesforce Org..."
            echo $SF_AUTH_URL > sfdx_auth_url.txt
            if command -v sf &> /dev/null
            then
              sf org login sfdx-url --set-default --alias myOrg --sfdx-url-file sfdx_auth_url.txt
            else
              echo "‚ùå Salesforce CLI not found!"
              exit 1
            fi

      - run:
          name: Deploy to Salesforce
          command: |
            echo "Deploying to Salesforce..."
            sf project deploy start --manifest package.xml

workflows:
  version: 2
  deploy:
    jobs:
      - deploy
