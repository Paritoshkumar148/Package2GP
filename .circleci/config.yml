version: 2.1

executors:
  salesforce-executor:
    docker:
      - image: cimg/node:18.17  # âœ… Lightweight Node.js image with npm pre-installed
    working_directory: ~/project

jobs:
  install_salesforce_cli:
    executor: salesforce-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - sf-cli-cache-v1-{{ checksum "package.json" }}  # âœ… Cache based on package.json changes
      - run:
          name: Install Salesforce CLI (Using Cache)
          command: |
            if sf --version > /dev/null 2>&1; then
              echo "âœ… Salesforce CLI already installed, skipping..."
            else
              echo "ðŸš€ Installing Salesforce CLI..."
              npm install --global @salesforce/cli --quiet
            fi
      - run:
          name: Verify Salesforce CLI
          command: sf --version
      - save_cache:
          paths:
            - ~/.npm-global
          key: sf-cli-cache-v1-{{ checksum "package.json" }}

  deploy:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Authenticate Salesforce Org
          command: |
            echo "Authenticating Salesforce Org..."
            echo $SF_AUTH_URL | sf org login sfdx-url --set-default --instance-url=https://login.salesforce.com --alias myOrg --json
      - run:
          name: Deploy Salesforce Package
          command: |
            echo "ðŸš€ Deploying to Salesforce..."
            sf project deploy start --wait 10
      - run:
          name: Run Tests
          command: sf apex run test --result-format human

workflows:
  version: 2
  deploy:
    jobs:
      - install_salesforce_cli
      - deploy:
          requires:
            - install_salesforce_cli
