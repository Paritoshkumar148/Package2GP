version: 2.1

executors:
  default:
    docker:
      - image: cimg/node:18.17 # Correct Node.js image
    working_directory: ~/project

jobs:
  deploy:
    executor: default
    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: npm install

      - run:
          name: Install Salesforce CLI
          command: |
            echo "ðŸš€ Installing Salesforce CLI..."
            mkdir -p $HOME/.npm-global
            npm config set prefix $HOME/.npm-global
            export PATH=$HOME/.npm-global/bin:$PATH
            npm install -g @salesforce/cli
            echo 'export PATH=$HOME/.npm-global/bin:$PATH' >> $HOME/.bashrc
            echo "âœ… Salesforce CLI installed successfully!"
            sf --version  # Verify installation

      - run:
          name: Authenticate Salesforce Org using JWT OAuth
          command: |
            echo "ðŸ” Authenticating Salesforce Org..."
            export PATH=$HOME/.npm-global/bin:$PATH  # Ensure PATH is updated

            # Validate required environment variables 1234562134561234562345
            if [[ -z "$SF_CONSUMER_KEY" || -z "$SF_USERNAME" || -z "$SF_INSTANCE_URL" || -z "$SF_JWT_KEY" ]]; then
              echo "âŒ ERROR: One or more required environment variables are missing!"
              echo "Required: SF_CONSUMER_KEY, SF_USERNAME, SF_INSTANCE_URL, SF_JWT_KEY"
              exit 1
            fi

            # Convert SF_JWT_KEY to a valid key file1234
            echo -e "$SF_JWT_KEY" | sed 's/\\n/\n/g' > server.key
            chmod 600 server.key  # Secure key file

            # Authenticate with Salesforce
            sf org login jwt \
              --client-id "$SF_CONSUMER_KEY" \
              --jwt-key-file server.key \
              --username "$SF_USERNAME" \
              --instance-url "$SF_INSTANCE_URL" \
              --set-default \
              --alias myOrg

            echo "âœ… Authentication successful!"

      - run:
          name: Create Scratch Org & Deploy Metadata
          command: |
            echo "ðŸ“Œ Creating Scratch Org..."
            export PATH=$HOME/.npm-global/bin:$PATH  # Ensure PATH is updated
            sf org create scratch --definition-file config/project-scratch-def.json --set-default --alias scratchOrg --duration-days 7
            echo "âœ… Scratch org created!"

            echo "ðŸš€ Deploying metadata to scratch org..."
            sf project deploy start --target-org scratchOrg
            echo "âœ… Metadata deployed!"

      - run:
          name: Run Apex Tests with Code Coverage
          command: |
            echo "ðŸ§ª Running Apex tests..."
            export PATH=$HOME/.npm-global/bin:$PATH  # Ensure PATH is updated
            sf apex run test --target-org scratchOrg --result-format human --code-coverage --wait 10
            echo "âœ… Apex tests completed!"

      - run:
          name: Deploy to Production Org
          command: |
            echo "ðŸš€ Deploying to Production..."
            export PATH=$HOME/.npm-global/bin:$PATH  # Ensure PATH is updated
            sf project deploy start --target-org myOrg --manifest package.xml --test-level RunLocalTests
            echo "âœ… Deployment to Production completed!"

workflows:
  version: 2
  deploy:
    jobs:
      - deploy
