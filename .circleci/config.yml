version: 2.1

executors:
  default:
    docker:
      - image: cimg/node:18.17 # Use latest compatible Node.js version
    working_directory: ~/project

jobs:
  deploy:
    executor: default
    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: npm install

      - run:
          name: Install Salesforce CLI
          command: |
            echo "🚀 Installing Salesforce CLI..."
            mkdir -p $HOME/.npm-global
            npm config set prefix $HOME/.npm-global
            export PATH=$HOME/.npm-global/bin:$PATH
            npm install -g @salesforce/cli
            echo 'export PATH=$HOME/.npm-global/bin:$PATH' >> $HOME/.bashrc
            echo "✅ Salesforce CLI installed successfully!"
            sf --version  # Verify installation

      - run:
          name: Authenticate Dev Hub using SFDX Auth URL
          command: |
            echo "🔐 Authenticating Dev Hub..."
            if [[ -z "$SF_AUTH_URL" ]]; then
              echo "❌ ERROR: SF_AUTH_URL environment variable is missing!"
              exit 1
            fi
            echo "$SF_AUTH_URL" > sfdx_auth_url.txt
            sf org login sfdx-url -f sfdx_auth_url.txt --set-default-dev-hub
            echo "✅ Dev Hub authentication successful!"

      - run:
          name: Authenticate Target Org
          command: |
            echo "🔐 Authenticating Target Org..."
            if [[ -z "$SF_TARGET_AUTH_URL" ]]; then
              echo "❌ ERROR: SF_TARGET_AUTH_URL environment variable is missing!"
              exit 1
            fi
            echo "$SF_TARGET_AUTH_URL" > target_auth.txt
            sf org login sfdx-url -f target_auth.txt --set-default --alias myOrg
            echo "✅ Target Org authentication successful!"

      - run:
          name: Create Scratch Org & Deploy Metadata
          command: |
            echo "📌 Creating Scratch Org..."
            sf org create scratch --definition-file config/project-scratch-def.json --set-default --alias scratchOrg --duration-days 7
            echo "✅ Scratch org created!"

            echo "🚀 Deploying metadata to scratch org..."
            sf project deploy start --target-org scratchOrg
            echo "✅ Metadata deployed!"

      - run:
          name: Run Apex Tests with Code Coverage
          command: |
            echo "🧪 Running Apex tests..."
            sf apex run test --target-org scratchOrg --result-format human --code-coverage --wait 10
            echo "✅ Apex tests completed!"

      - run:
          name: Deploy to Production Org
          command: |
            echo "🚀 Deploying to Production..."
            sf project deploy start --target-org myOrg --manifest package.xml --test-level RunLocalTests
            echo "✅ Deployment to Production completed!"

workflows:
  version: 2
  deploy:
    jobs:
      - deploy
