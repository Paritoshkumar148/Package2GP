version: 2.1

executors:
  salesforce-executor:
    docker:
      - image: cimg/node:18.17  # âœ… Uses Node.js environment
    working_directory: ~/project

jobs:
  setup:
    executor: salesforce-executor
    steps:
      - checkout

      - run:
          name: Install Salesforce CLI
          command: |
            mkdir ~/sfdx
            curl -sSL https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz | tar -xJ -C ~/sfdx --strip-components=1
            echo 'export PATH="$HOME/sfdx/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Verify Salesforce CLI
          command: sfdx --version

  authenticate:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Authenticate with Salesforce
          command: |
            echo $SFDC_JWT_KEY | base64 --decode > server.key
            sfdx auth:jwt:grant --client-id $SFDC_CONSUMER_KEY --jwt-key-file server.key --username $SFDC_USERNAME --instance-url https://login.salesforce.com
            sfdx force:org:list

  create-scratch-org:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Create Scratch Org
          command: sfdx force:org:create -f config/project-scratch-def.json -a CircleCIScratchOrg -d 1 -s
      
      - run:
          name: Push Source Code
          command: sfdx force:source:push
      
      - run:
          name: Run Apex Tests
          command: sfdx force:apex:test:run --resultformat human --codecoverage --wait 10
      
      - run:
          name: Delete Scratch Org
          command: sfdx force:org:delete -u CircleCIScratchOrg -p

  deploy-to-prod:
    executor: salesforce-executor
    steps:
      - checkout
      - run:
          name: Deploy to Production
          command: sfdx force:source:deploy -x manifest/package.xml -u $SFDC_USERNAME --wait 10

workflows:
  version: 2
  deploy:
    jobs:
      - setup
      - authenticate:
          requires:
            - setup
      - create-scratch-org:
          requires:
            - authenticate
      - deploy-to-prod:
          requires:
            - create-scratch-org
