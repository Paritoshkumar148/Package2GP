version: 2.1

executors:
  sf_executor:
    docker:
      - image: cimg/node:18.16
    working_directory: ~/project

jobs:
  auth:
    executor: sf_executor
    steps:
      - checkout
      - run:
          name: Install Salesforce CLI
          command: npm install --global sfdx-cli
      - run:
          name: Authenticate with Salesforce
          command: |
            echo "$SF_JWT_SECRET" > server.key
            sfdx auth:jwt:grant --client-id $SF_CONSUMER_KEY --jwt-key-file server.key --username $SF_USERNAME --set-default-dev-hub

  deploy:
    executor: sf_executor
    steps:
      - checkout
      - run:
          name: Install Salesforce CLI
          command: npm install --global sfdx-cli
      - run:
          name: Authenticate with Salesforce
          command: |
            echo "$SF_JWT_SECRET" > server.key
            sfdx auth:jwt:grant --client-id $SF_CONSUMER_KEY --jwt-key-file server.key --username $SF_USERNAME --set-default-dev-hub
      - run:
          name: Deploy to Salesforce
          command: sfdx force:source:deploy -p force-app -u $SF_USERNAME --json --loglevel fatal

workflows:
  version: 2
  deploy_flow:
    jobs:
      - auth
      - deploy:
          requires:
            - auth
